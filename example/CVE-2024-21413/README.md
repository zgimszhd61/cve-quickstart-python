# CVE-2024-21413 | Microsoft Outlook Remote Code Execution Vulnerability PoC

## ğŸ“œ Description

æœ¬è„šæœ¬æä¾›äº†CVE-2024-21413çš„æ¦‚å¿µéªŒè¯ï¼ˆPoCï¼‰ï¼Œè¿™æ˜¯åœ¨Microsoft Outlookä¸­å‘ç°çš„ä¸€ä¸ªé‡å¤§å®‰å…¨æ¼æ´ï¼ŒCVSSè¯„åˆ†ä¸º9.8ã€‚è¢«ç§°ä¸º#MonikerLinkæ¼æ´ï¼Œè¿™ä¸ªæ¼æ´çš„å½±å“æ·±è¿œï¼ŒåŒ…æ‹¬å¯èƒ½æ³„éœ²æœ¬åœ°NTLMä¿¡æ¯å’Œè¿œç¨‹ä»£ç æ‰§è¡Œçš„å¯èƒ½æ€§ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æ­ç¤ºäº†ä¸€ä¸ªå¯ä»¥ç»•è¿‡Officeå—ä¿æŠ¤è§†å›¾çš„æ”»å‡»é€”å¾„ï¼Œå› æ­¤æ‰©å¤§äº†å…¶å¯¹å…¶ä»–Officeåº”ç”¨ç¨‹åºçš„å¨èƒã€‚

## ğŸš€ Usage

è¯·è´Ÿè´£ä»»åœ°ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼Œå¹¶ç¡®ä¿ä½ æœ‰ç›®æ ‡ç³»ç»Ÿæ‰€æœ‰è€…çš„æˆæƒã€‚è¿™ä¸ªè„šæœ¬éœ€è¦SMTPè®¤è¯æ¥å‘é€ç”µå­é‚®ä»¶ï¼Œç»•è¿‡SPFã€DKIMå’ŒDMARCæ£€æŸ¥ï¼Œè¿™æœ‰åŠ©äºæ›´æœ‰æ•ˆåœ°æ¨¡æ‹Ÿç°å®ä¸–ç•Œçš„æ”»å‡»åœºæ™¯ã€‚

```bash
python CVE-2024-21413.py --server "<SMTP server>" --port <SMTP port> --username "<SMTP username>" --password "<SMTP password>" --sender "<sender email>" --recipient "<recipient email>" --url "<link URL>" --subject "<email subject>"
```

**Parameters:**

- `--server`: SMTP server hostname or IP.
- `--port`: SMTP server port.
- `--username`: SMTP server username for authentication.
- `--password`: SMTP server password for authentication.
- `--sender`: Sender email address.
- `--recipient`: Recipient email address.
- `--url`: Malicious path to include in the email.
- `--subject`: Email subject.

### Initial Sending 

<img width="730" alt="image" src="https://github.com/xaitax/CVE-2024-21413-Microsoft-Outlook-Remote-Code-Execution-Vulnerability/assets/5014849/5b68f853-e278-48cc-98fa-f560509d7d44">

### Display in Outlook (no warnings, no Protected view)

![image](https://github.com/xaitax/CVE-2024-21413-Microsoft-Outlook-Remote-Code-Execution-Vulnerability/assets/5014849/914110cb-ee5d-432a-bac5-c8243015658a)

### Wireshark capture including NTLM credentials (you can also run impacket, alternatively)

<img width="604" alt="image" src="https://github.com/xaitax/CVE-2024-21413-Microsoft-Outlook-Remote-Code-Execution-Vulnerability/assets/5014849/89edf325-9a16-4977-be3a-4e9064bb003f">

## ğŸ§ Why SMTP Authentication?

SMTPè®¤è¯å¯¹äºæœ¬æ¼”ç¤ºè‡³å…³é‡è¦ï¼Œä»¥ç¡®ä¿å‘é€çš„ç”µå­é‚®ä»¶ç»•è¿‡å¸¸è§çš„ç”µå­é‚®ä»¶éªŒè¯æ£€æŸ¥ï¼Œå¦‚SPFï¼ˆå‘ä»¶äººç­–ç•¥æ¡†æ¶ï¼‰ã€DKIMï¼ˆåŸŸå¯†é’¥è¯†åˆ«é‚®ä»¶ï¼‰å’ŒDMARCï¼ˆåŸºäºåŸŸçš„æ¶ˆæ¯è®¤è¯ã€æŠ¥å‘Šå’Œåˆè§„æ€§ï¼‰ã€‚è¿™äº›å®‰å…¨æªæ–½æ—¨åœ¨æ£€æµ‹å’Œé˜²æ­¢ç”µå­é‚®ä»¶æ¬ºéª—ï¼Œå…¶ä¸­æ”»å‡»è€…ä»ä¼ªé€ çš„åœ°å€å‘é€ç”µå­é‚®ä»¶ã€‚é€šè¿‡ä½¿ç”¨ç»è¿‡è®¤è¯çš„SMTPï¼Œæ¼”ç¤ºæ›´è´´è¿‘äºä¸€ä¸ªå¤æ‚æ”»å‡»è€…å¦‚ä½•ç»•è¿‡è¿™äº›ä¿æŠ¤çš„æ–¹å¼ï¼Œä½¿æµ‹è¯•ç¯å¢ƒæ›´åŠ çœŸå®ï¼Œå¹¶å¼ºè°ƒäº†å…¨é¢çš„ç”µå­é‚®ä»¶å®‰å…¨å®è·µçš„é‡è¦æ€§ã€‚

## Demos

### 0-click NTLM Leak

![CVE-2024-21413-NTLM_Leak-0-click-Text](https://github.com/xaitax/CVE-2024-21413-Microsoft-Outlook-Remote-Code-Execution-Vulnerability/assets/5014849/8e23f3cd-1904-4d3e-b5d3-a0b58c0318b7)

### 1-click Remote Code Execution (RCE)

![CVE-2024-21413-RCE](https://github.com/xaitax/CVE-2024-21413-Microsoft-Outlook-Remote-Code-Execution-Vulnerability/assets/5014849/cd0dbae7-aaec-4532-9114-b58239fe5775)

## ğŸ“† Changelog

### [19. February 2024] - Added 0-Click NTLM Leak

- Confirmed and managed 0-click NTLM Leak (thanks to [JT](https://x.com/johntroony)!)
- Not yet published

### [18. February 2024] - Added 1-click RCE

- Managed & confirmed Microsoft Outlook Remote Code Execution (RCE)
- Not yet published

### [16. February 2024] - Initial Release

- Initial release showcasing the exploit for CVE-2024-21413.

## Credits

- [Checkpoint](https://research.checkpoint.com/2024/the-risks-of-the-monikerlink-bug-in-microsoft-outlook-and-the-big-picture/) has done all the amazing research.
- [Microsoft Security Advisory](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-21413)

## ğŸ“Œ Author

**Alexander Hagenah**
- [Website](https://primepage.de)
- [Twitter](https://twitter.com/xaitax)
- [LinkedIn](https://www.linkedin.com/in/alexhagenah/)

## âš ï¸ Disclaimer

æ­¤å·¥å…·ä»…ç”¨äºæ•™è‚²å’Œä¼¦ç†æµ‹è¯•ç›®çš„ã€‚æœªç»æˆæƒçš„æ‰«æã€æµ‹è¯•æˆ–åˆ©ç”¨ç³»ç»Ÿæ˜¯éæ³•å’Œä¸é“å¾·çš„ã€‚ç¡®ä¿ä½ æœ‰æ˜ç¡®çš„ã€æˆæƒçš„è®¸å¯æ¥è¿›è¡Œä»»ä½•é’ˆå¯¹ç›®æ ‡ç³»ç»Ÿçš„æµ‹è¯•æˆ–åˆ©ç”¨æ´»åŠ¨ã€‚



